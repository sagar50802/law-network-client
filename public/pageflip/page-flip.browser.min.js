// public/pageflip/page-flip.browser.min.js
// Simple double-page flip engine with CSS 3D-style animation.
// Exposes a single global: window.PageFlip

(function (global) {
  "use strict";

  function clamp(value, min, max) {
    return Math.min(max, Math.max(min, value));
  }

  function getRect(el) {
    var r = el.getBoundingClientRect();
    return { left: r.left, top: r.top, width: r.width, height: r.height };
  }

  function SimplePageFlip(root, options) {
    if (!root || !(root instanceof HTMLElement)) {
      throw new Error("PageFlip container must be a DOM element");
    }

    this.root = root;
    this.opts = Object.assign(
      {
        width: 600,
        height: 800,
        flippingTime: 800, // ms
      },
      options || {}
    );

    this.images = [];
    this.currentPage = 0; // left page index of the spread
    this.handlers = { flip: [] };

    this._touchX = null;
    this._flipTimer = null;

    this._setupDOM();
    this._bindEvents();
  }

  SimplePageFlip.prototype._setupDOM = function () {
    this.root.innerHTML = "";

    var wrapper = document.createElement("div");
    wrapper.className = "pf-wrapper";
    this.wrapper = wrapper;
    this.root.appendChild(wrapper);

    var spread = document.createElement("div");
    spread.className = "pf-spread";
    this.spread = spread;
    wrapper.appendChild(spread);
  };

  SimplePageFlip.prototype._bindEvents = function () {
    var self = this;

    // Mouse click: left/right half
    this.wrapper.addEventListener("click", function (evt) {
      if (!self.images.length) return;
      var rect = getRect(self.wrapper);
      var x = evt.clientX - rect.left;
      if (x > rect.width / 2) self.flipNext();
      else self.flipPrev();
    });

    // Touch swipe
    this.wrapper.addEventListener(
      "touchstart",
      function (evt) {
        if (!evt.touches || !evt.touches.length) return;
        self._touchX = evt.touches[0].clientX;
      },
      { passive: true }
    );

    this.wrapper.addEventListener(
      "touchend",
      function (evt) {
        if (self._touchX == null) return;
        if (!evt.changedTouches || !evt.changedTouches.length) return;

        var dx = evt.changedTouches[0].clientX - self._touchX;
        self._touchX = null;

        if (dx < -30) self.flipNext();
        else if (dx > 30) self.flipPrev();
      },
      { passive: true }
    );
  };

  SimplePageFlip.prototype._emit = function (name, payload) {
    var list = this.handlers[name];
    if (!list) return;
    list.forEach(function (fn) {
      try {
        fn(payload || {});
      } catch (err) {
        // ignore handler errors
        console.error(err);
      }
    });
  };

  SimplePageFlip.prototype.on = function (name, fn) {
    if (!this.handlers[name]) this.handlers[name] = [];
    this.handlers[name].push(fn);
  };

  SimplePageFlip.prototype.loadFromImages = function (images) {
    if (!Array.isArray(images)) {
      throw new Error("loadFromImages expects an array of image URLs");
    }
    this.images = images.slice();
    this.currentPage = 0;
    this._renderSpread();
  };

  SimplePageFlip.prototype._renderSpread = function () {
    var total = this.images.length;
    if (!total) {
      this.spread.innerHTML = "";
      return;
    }

    // ensure left page index is even and inside bounds
    var left = clamp(this.currentPage, 0, total - 1);
    if (left % 2 === 1) left -= 1;
    this.currentPage = clamp(left, 0, total - 1);

    var right = this.currentPage + 1 < total ? this.currentPage + 1 : null;

    // clear spread
    this.spread.innerHTML = "";

    var makePage = function (idx, side) {
      if (idx == null) return;
      var page = document.createElement("div");
      page.className = "pf-page " + side;
      page.setAttribute("data-index", String(idx));

      var img = document.createElement("img");
      img.src = images[idx];
      img.alt = "Page " + (idx + 1);

      page.appendChild(img);
      spread.appendChild(page);
    };

    var images = this.images;
    var spread = this.spread;

    makePage(this.currentPage, "left");
    if (right !== null) makePage(right, "right");
  };

  SimplePageFlip.prototype._runFlipAnimation = function (cls) {
    var self = this;
    if (!this.spread) return;

    this.spread.classList.remove("pf-flip-next", "pf-flip-prev");
    // Render new spread before animation so pages show correct content
    this._renderSpread();
    this.spread.classList.add(cls);

    if (this._flipTimer) clearTimeout(this._flipTimer);
    this._flipTimer = setTimeout(function () {
      if (self.spread) {
        self.spread.classList.remove("pf-flip-next", "pf-flip-prev");
      }
    }, this.opts.flippingTime || 800);

    this._emit("flip", { data: this.currentPage });
  };

  SimplePageFlip.prototype.flipNext = function () {
    if (!this.images.length) return;

    var total = this.images.length;
    var maxLeft = total % 2 === 0 ? total - 2 : total - 1;
    var next = this.currentPage + 2;

    if (next > maxLeft) return;

    this.currentPage = next;
    this._runFlipAnimation("pf-flip-next");
  };

  SimplePageFlip.prototype.flipPrev = function () {
    if (!this.images.length) return;

    var prev = this.currentPage - 2;
    if (prev < 0) return;

    this.currentPage = prev;
    this._runFlipAnimation("pf-flip-prev");
  };

  SimplePageFlip.prototype.turnToPage = function (index) {
    if (!this.images.length) return;
    if (typeof index !== "number") return;

    var total = this.images.length;
    if (index < 0 || index >= total) return;

    var target = index % 2 === 0 ? index : index - 1;
    target = clamp(target, 0, total - 1);

    if (target === this.currentPage) return;

    var cls = target > this.currentPage ? "pf-flip-next" : "pf-flip-prev";
    this.currentPage = target;
    this._runFlipAnimation(cls);
  };

  SimplePageFlip.prototype.getState = function () {
    return {
      currentPage: this.currentPage,
    };
  };

  SimplePageFlip.prototype.destroy = function () {
    if (this._flipTimer) clearTimeout(this._flipTimer);
    if (this.wrapper) {
      this.wrapper.innerHTML = "";
    }
    this.root.innerHTML = "";
    this.images = [];
    this.handlers = { flip: [] };
  };

  // export
  global.PageFlip = SimplePageFlip;
})(window);
