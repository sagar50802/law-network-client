/* PageFlip Engine — Real Double-Page + Animation — Compact Build */
!function(w){class PageFlip{
  constructor(el,opts={}) {
    this.el=el;
    this.opts=Object.assign({
      width:600,
      height:800,
      showCover:true,
      usePortrait:false,
      flippingTime:800
    },opts);
    this.pages=[];
    this.current=0;
    this.wrapper=null;
  }

  loadFromImages(arr){
    this.pages=arr;
    this._build();
    this._renderSpread(0);
  }

  _build(){
    this.el.innerHTML="";
    const wrap=document.createElement("div");
    wrap.style.width="100%";
    wrap.style.height="100%";
    wrap.style.position="relative";
    wrap.style.perspective="2000px";
    wrap.style.transformStyle="preserve-3d";
    this.wrapper=wrap;
    this.el.appendChild(wrap);
  }

  _renderSpread(i){
    this.wrapper.innerHTML="";

    const left=document.createElement("div");
    const right=document.createElement("div");

    left.className="pf-page left";
    right.className="pf-page right";

    left.innerHTML=`<img src="${this.pages[i]||""}"/>`;
    right.innerHTML=`<img src="${this.pages[i+1]||""}"/>`;

    this.wrapper.appendChild(left);
    this.wrapper.appendChild(right);
    this.current=i;
  }

  flipNext(){
    if (this.current < this.pages.length-2){
      this._animate("next");
      setTimeout(()=>{
        this._renderSpread(this.current+2)
      },this.opts.flippingTime);
    }
  }

  flipPrev(){
    if (this.current > 0){
      this._animate("prev");
      setTimeout(()=>{
        this._renderSpread(this.current-2)
      },this.opts.flippingTime);
    }
  }

  turnToPage(i){
    const even = i % 2 === 0 ? i : i - 1;
    this._renderSpread(even);
  }

  _animate(dir){
    const c=this.wrapper;
    c.classList.remove("flip-next","flip-prev");
    void c.offsetWidth;
    c.classList.add(dir==="next"?"flip-next":"flip-prev");
  }

  getState(){ return { currentPage:this.current }; }
  destroy(){ this.el.innerHTML=""; }
}
w.PageFlip=PageFlip}(window);
